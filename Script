-- Roblox Lua Script for "Granny Multiplayer - Chapter 2" Map (By BMF)
-- Script handles a draggable UI with multiple functionalities

-- Variables
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")
local UIS = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Create UI Elements
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local LocationLabel = Instance.new("TextLabel")
local ErrorLog = Instance.new("TextLabel")
local UIListLayout = Instance.new("UIListLayout")

-- UI Properties
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false
ScreenGui.Name = "GrannyUI"

MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Size = UDim2.new(0, 300, 0, 400)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Visible = true

Title.Parent = MainFrame
Title.Text = "Granny Multiplayer - Chapter 2 (By BMF)"
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

ErrorLog.Parent = MainFrame
ErrorLog.Text = "Error Log: None"
ErrorLog.Size = UDim2.new(1, 0, 0, 30)
ErrorLog.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
ErrorLog.TextColor3 = Color3.fromRGB(255, 85, 85)
ErrorLog.Font = Enum.Font.SourceSans
ErrorLog.TextSize = 14
ErrorLog.TextWrapped = true
ErrorLog.TextYAlignment = Enum.TextYAlignment.Top

UIListLayout.Parent = MainFrame
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- Toggle UI with Delete key
UIS.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.Delete then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

-- Function to Create Buttons
local function createButton(name, callback)
    local Button = Instance.new("TextButton")
    Button.Parent = MainFrame
    Button.Text = name
    Button.Size = UDim2.new(1, 0, 0, 30)
    Button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Button.TextColor3 = Color3.fromRGB(255, 255, 255)
    Button.Font = Enum.Font.SourceSans
    Button.TextSize = 16
    Button.MouseButton1Click:Connect(function()
        pcall(callback)
    end)
    return Button
end

createButton("Infinite Yield", function()
    local success, result = pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))()
    end)
    if success then
        print("Infinite Yield executed!")
    else
        print("Error executing Infinite Yield")
    end
end)

createButton("Dex Explorer", function()
    local success, result = pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/infyiff/backup/main/dex.lua"))()
    end)
    if success then
        print("Dex Explorer executed!")
    else
        print("Error executing Dex Explorer")
    end
end)

-- ✅ Notification when script loads
StarterGui:SetCore("SendNotification", {
    Title = "Granny Script Loaded!";
    Text = "All features are ready.";
    Duration = 10;
})

-- ✅ ESP helper
local function highlightTarget(target, color)
    local highlight = Instance.new("Highlight")
    highlight.Adornee = target
    highlight.FillColor = color
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.Parent = target
end

-- ✅ Tracer helper
local function createTracer(target, color)
    local RunService = game:GetService("RunService")
    local camera = workspace.CurrentCamera
    local line = Drawing.new("Line")
    line.Visible = true
    line.Color = color
    line.Thickness = 2

    -- Update tracer position every frame
    local connection
    connection = RunService.RenderStepped:Connect(function()
        if target and target:FindFirstChild("HumanoidRootPart") and target:FindFirstChildOfClass("Humanoid") then
            local hrp = target:FindFirstChild("HumanoidRootPart")
            local pos, onScreen = camera:WorldToViewportPoint(hrp.Position)
            if onScreen then
                line.From = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y) -- from bottom center of screen
                line.To = Vector2.new(pos.X, pos.Y)
                line.Visible = true
            else
                line.Visible = false
            end
        else
            line.Visible = false
            connection:Disconnect()
            line:Remove()
        end
    end)
end

-- ✅ Floating Name helper
local function createNameTag(target, text, color)
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "NameTag"
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 500
    billboard.Parent = target

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = color
    label.TextStrokeTransparency = 0
    label.TextScaled = true
    label.Font = Enum.Font.SourceSansBold
    label.Parent = billboard
end


-- ✅ Add Buttons Below

createButton("Granny ESP", function()
    local granny = nil

    for i = 1, 5 do
        local preset = workspace:FindFirstChild("Preset" .. i)
        if preset and preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("Granny") then
            granny = preset.Locks.Granny
            break
        end
    end

    if granny and granny:IsA("Model") then
        -- Highlight
        if not granny:FindFirstChildOfClass("Highlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "GrannyESP"
            highlight.Parent = granny
            highlight.Adornee = granny
            highlight.FillTransparency = 1
            highlight.OutlineTransparency = 0
            highlight.OutlineColor = Color3.fromRGB(255, 0, 0) -- Red
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        end

        -- Tracer
        createTracer(granny, Color3.fromRGB(255, 0, 0))

        -- Name Tag
        if not granny:FindFirstChild("NameTag") then
            createNameTag(granny, "Granny", Color3.fromRGB(255, 0, 0))
        end
    else
        ErrorLog.Text = "Error Log: Granny not found in Preset1 to Preset5"
    end
end)

createButton("Grandpa ESP", function()
    local grandpa = nil

    -- Search through Preset1–Preset5 for Grandpa
    for i = 1, 5 do
        local preset = workspace:FindFirstChild("Preset" .. i)
        if preset and preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("Grandpa") then
            grandpa = preset.Locks.Grandpa
            break
        end
    end

    if grandpa and grandpa:IsA("Model") then
        -- Highlight (green)
        if not grandpa:FindFirstChildOfClass("Highlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "GrandpaESP"
            highlight.Parent = grandpa
            highlight.Adornee = grandpa
            highlight.FillTransparency = 1
            highlight.OutlineTransparency = 0
            highlight.OutlineColor = Color3.fromRGB(0, 255, 0) -- Green
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        end

        -- Tracer (green)
        createTracer(grandpa, Color3.fromRGB(0, 255, 0))

        -- Name Tag (green)
        if not grandpa:FindFirstChild("NameTag") then
            createNameTag(grandpa, "Grandpa", Color3.fromRGB(0, 255, 0))
        end
    else
        ErrorLog.Text = "Error Log: Grandpa not found in Preset1 to Preset5"
    end
end)

createButton("Item ESP", function()
    local itemNames = {
        "Boat key",
        "Boat steering wheel",
        "Crowbar",
        "Cutting pliers",
        "Door handle",
        "Door lock",
        "Duct tape",
        "Gasoline can",
        "Glass fuse",
        "Hand wheel",
        "Helicopter key",
        "Padlock key",
        "Safe key",
        "Spark plug",
        "Special key",
        "Stun gun",
        "Weapon key",
        "Wrench"
    }

    local color = Color3.fromRGB(0, 170, 255) -- Light blue ESP color for items
    local foundCount = 0

    -- Scan Preset1–Preset10 for listed items
    for i = 1, 10 do
        local preset = workspace:FindFirstChild("Preset" .. i)
        if preset then
            for _, itemName in ipairs(itemNames) do
                local item = preset:FindFirstChild(itemName, true)
                if item and item:IsA("Model") or item:IsA("Part") then
                    -- Apply highlight
                    if not item:FindFirstChildOfClass("Highlight") then
                        local highlight = Instance.new("Highlight")
                        highlight.Name = "ItemESP"
                        highlight.Parent = item
                        highlight.Adornee = item
                        highlight.FillTransparency = 1
                        highlight.OutlineTransparency = 0
                        highlight.OutlineColor = color
                        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                    end

                    -- Create name tag
                    if not item:FindFirstChild("NameTag") then
                        createNameTag(item, itemName, color)
                    end

                    -- Tracer
                    createTracer(item, color)
                    foundCount += 1
                end
            end
        end
    end

    print("Item ESP applied to " .. foundCount .. " items.")
end)


createButton("Get All Items", function()
    local player = game.Players.LocalPlayer
    local backpack = player:FindFirstChild("Backpack")
    local character = player.Character or player.CharacterAdded:Wait()

    -- ✅ Helper: check if player already has tool
    local function hasTool(toolName)
        return backpack:FindFirstChild(toolName) or character:FindFirstChild(toolName)
    end

    -- ✅ Helper: try to fire or clone item
    local function obtainItem(item)
        if not item then return end
        if item:FindFirstChild("InteractRemote") then
            item.InteractRemote:FireServer(player)
            print("Picked up via InteractRemote:", item.Name)
        elseif item:IsA("Tool") then
            local clone = item:Clone()
            clone.Parent = backpack
            print("Manually cloned tool:", item.Name)
        else
            print("⚠️ Unable to pick up item:", item.Name)
        end
        task.wait(0.1)
    end

    -- ✅ Step 1: Grab interactable items from all Presets
    for i = 1, 10 do
        local preset = workspace:FindFirstChild("Preset" .. i)
        if preset then
            for _, item in pairs(preset:GetChildren()) do
                if item:FindFirstChild("InteractRemote") then
                    obtainItem(item)
                end
            end
        end
    end)

createButton("Granny Ignores You", function()
    local grannyFolder = nil
    local foundPresetIndex = nil  -- ✅ store which preset Granny was found in

    for i = 1, 5 do
        local preset = workspace:FindFirstChild("Preset" .. i)
        if preset and preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("Granny") then
            grannyFolder = preset.Locks.Granny
            foundPresetIndex = i
            break
        end
    end

    if grannyFolder then
        local toDestroy = {
            "CameraJumpscare1",
            "CameraJumpscare2",
            "Jumpscare"
        }

        for _, name in ipairs(toDestroy) do
            local obj = grannyFolder:FindFirstChild(name)
            if obj then
                obj:Destroy()
            end
        end

        -- ✅ Use foundPresetIndex safely here
        if foundPresetIndex then
            local attackPath = workspace:FindFirstChild("Preset" .. foundPresetIndex)
            if attackPath and attackPath:FindFirstChild("Locks") and attackPath.Locks:FindFirstChild("Granny") and attackPath.Locks.Granny:FindFirstChild("Attack") then
                attackPath.Locks.Granny.Attack:Destroy()
            end
        end

        print("Granny will now ignore you!") -- ✅ will print correctly now
    else
        ErrorLog.Text = "Error Log: Granny paths not found in Preset1 to Preset5."
    end
end)

createButton("Grandpa Ignores You", function()
    local grandpaFolder = nil
    local foundPresetIndex = nil  -- ✅ store which preset Grandpa was found in

    for i = 1, 5 do
        local preset = workspace:FindFirstChild("Preset" .. i)
        if preset and preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("Grandpa") then
            grandpaFolder = preset.Locks.Grandpa
            foundPresetIndex = i
            break
        end
    end

    if grandpaFolder then
        local toDestroy = {
            "CameraJumpscare1",
            "CameraJumpscare2",
            "Jumpscare"
        }

        for _, name in ipairs(toDestroy) do
            local obj = grandpaFolder:FindFirstChild(name)
            if obj then
                obj:Destroy()
            end
        end

        -- ✅ Use foundPresetIndex safely here
        if foundPresetIndex then
            local attackPath = workspace:FindFirstChild("Preset" .. foundPresetIndex)
            if attackPath and attackPath:FindFirstChild("Locks") and attackPath.Locks:FindFirstChild("Grandpa") and attackPath.Locks.Grandpa:FindFirstChild("Attack") then
                attackPath.Locks.Grandpa.Attack:Destroy()
            end
        end

        print("Grandpa will now ignore you!") 
    else
        ErrorLog.Text = "Error Log: Grandpa paths not found in Preset1 to Preset5."
    end
end)

createButton("Remove Fall Animations", function()
    local paths = {
        workspace:FindFirstChild("GiveGUI")
            and workspace.GiveGUI:FindFirstChild("ShowGUI")
            and workspace.GiveGUI.ShowGUI:FindFirstChild("MainGUI")
            and workspace.GiveGUI.ShowGUI.MainGUI:FindFirstChild("FallSystem"),

        game:GetService("Players").LocalPlayer:FindFirstChild("PlayerGui")
            and game.Players.LocalPlayer.PlayerGui:FindFirstChild("MainGUI")
            and game.Players.LocalPlayer.PlayerGui.MainGUI:FindFirstChild("FallSystem")
    }

    for _, obj in pairs(paths) do
        if obj then
            obj:Destroy()
        end
    end

    print("Fall animations successfully removed!")
    game.StarterGui:SetCore("SendNotification", {
        Title = "Removed Fall Animations!",
        Text = "Removes the falling animation system for smoother movement.",
        Duration = 5
    })
end)

createButton("God Mode", function()
    local player = game:GetService("Players").LocalPlayer
    local char = player.Character or workspace:FindFirstChild(player.Name)

    if char then
        -- Optional God mode visual tweaks
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
                part.Anchored = false
                part.Transparency = 0.5
            end
        end

        -- Change Humanoid name to avoid detection (if it exists)
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.Name = "NotHumanoid"
        end

        -- Unanchor root part if found
        local root = char:FindFirstChild("HumanoidRootPart")
        if root then
            root.Anchored = false
        end

        -- Destroy target paths dynamically
        local function safeDestroy(path)
            if path then
                path:Destroy()
            end
        end

        safeDestroy(workspace:FindFirstChild(player.Name):FindFirstChild("Health"))
        safeDestroy(workspace:FindFirstChild(player.Name):FindFirstChild("HumanoidRootPart"):FindFirstChild("FreeFalling"))
        safeDestroy(workspace:FindFirstChild(player.Name):FindFirstChild("Animate"):FindFirstChild("fall"))
        safeDestroy(player:FindFirstChild("PlayerGui"):FindFirstChild("MainGUI"):FindFirstChild("FallSystem"))
    end
end)

createButton("Full Bright", function()
    Lighting.Ambient = Color3.new(1, 1, 1)
    Lighting.Brightness = 3
    Lighting.FogEnd = 100000
    Lighting.ClockTime = 14
end)

createButton("Unlock Camera", function()
    LocalPlayer.CameraMaxZoomDistance = 1000
    LocalPlayer.CameraMinZoomDistance = 0.5
end)
