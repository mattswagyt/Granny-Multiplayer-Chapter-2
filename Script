-- Roblox Lua Script for "Granny Multiplayer - Chapter 2" Map (By BMF)
-- Script handles a draggable UI with multiple functionalities

-- Services
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Create UI Elements
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ErrorLog = Instance.new("TextLabel")
local ScrollFrame = Instance.new("ScrollingFrame")
local UIListLayout = Instance.new("UIListLayout")

-- UI Properties
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false
ScreenGui.Name = "GrannyUI"

MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Size = UDim2.new(0, 300, 0, 400)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
MainFrame.Active = true
MainFrame.Draggable = true

-- Title
Title.Parent = MainFrame
Title.Text = "Granny Multiplayer - Chapter 2 (By BMF)"
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

-- Error Log
ErrorLog.Parent = MainFrame
ErrorLog.Text = "Error Log: None"
ErrorLog.Size = UDim2.new(1, 0, 0, 40)
ErrorLog.Position = UDim2.new(0, 0, 0, 30)
ErrorLog.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
ErrorLog.TextColor3 = Color3.fromRGB(255, 85, 85)
ErrorLog.Font = Enum.Font.SourceSans
ErrorLog.TextSize = 14
ErrorLog.TextWrapped = true
ErrorLog.TextYAlignment = Enum.TextYAlignment.Top

-- ScrollingFrame for buttons
ScrollFrame.Parent = MainFrame
ScrollFrame.Size = UDim2.new(1, -10, 1, -75) 
ScrollFrame.Position = UDim2.new(0, 5, 0, 70)
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ScrollFrame.ScrollBarThickness = 6
ScrollFrame.BackgroundTransparency = 1

-- Layout inside scroll area
UIListLayout.Parent = ScrollFrame
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 5)

-- Auto-expand scroll size when buttons are added
UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ScrollFrame.CanvasSize = UDim2.fromOffset(0, UIListLayout.AbsoluteContentSize.Y)
end)

-- Toggle UI with Delete key
UIS.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.Delete then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

-- Function to Create Buttons
local function createButton(name, callback)
    local Button = Instance.new("TextButton")
    Button.Parent = ScrollFrame
    Button.Text = name
    Button.Size = UDim2.new(1, 0, 0, 35)
    Button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Button.TextColor3 = Color3.fromRGB(255, 255, 255)
    Button.Font = Enum.Font.SourceSans
    Button.TextSize = 16

    Button.MouseButton1Click:Connect(function()
        pcall(callback)
    end)
end

-- Loaders
createButton("Infinite Yield", function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))()
    print("Infinite Yield executed!")
end)

createButton("Dex Explorer", function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/infyiff/backup/main/dex.lua"))()
    print("Dex Explorer executed!")
end)

-- Notification on script load
StarterGui:SetCore("SendNotification", {
    Title = "Granny Script Loaded!";
    Text = "All features are ready.";
    Duration = 10
})

-- ESP Helpers
local function createTracer(target, color)
    local line = Drawing.new("Line")
    line.Visible = true
    line.Color = color
    line.Thickness = 2

    local connection
    connection = RunService.RenderStepped:Connect(function()
        if target and target:FindFirstChild("HumanoidRootPart") and target:FindFirstChildOfClass("Humanoid") then
            local hrp = target.HumanoidRootPart
            local pos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(hrp.Position)
            if onScreen then
                line.From = Vector2.new(workspace.CurrentCamera.ViewportSize.X / 2, workspace.CurrentCamera.ViewportSize.Y)
                line.To = Vector2.new(pos.X, pos.Y)
                line.Visible = true
            else
                line.Visible = false
            end
        else
            line.Visible = false
            connection:Disconnect()
            line:Remove()
        end
    end)
end

local function createNameTag(target, text, color)
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "NameTag"
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 500
    billboard.Parent = target

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = color
    label.TextStrokeTransparency = 0
    label.TextScaled = true
    label.Font = Enum.Font.SourceSansBold
    label.Parent = billboard
end

createButton("Player ESP", function()
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer

    local ESP_COLOR = Color3.fromRGB(0, 255, 0) -- Green

    -- Function to ESP a single character model
    local function applyPlayerESP(character, player)
        if not character then return end
        if character:FindFirstChild("HumanoidRootPart") == nil then return end

        -- Prevent duplicate ESP
        if character:FindFirstChild("PlayerESP_Highlight") then return end

        -- Highlight
        local highlight = Instance.new("Highlight")
        highlight.Name = "PlayerESP_Highlight"
        highlight.Adornee = character
        highlight.FillColor = ESP_COLOR
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0
        highlight.Parent = character

        -- Tracer
        createTracer(character, ESP_COLOR)

        -- Name tag
        createNameTag(character, player.Name, ESP_COLOR)
    end

    -- Apply ESP for all current players
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if player.Character then
                applyPlayerESP(player.Character, player)
            end
        end
    end

    -- When a new character spawns, apply ESP again
    Players.PlayerAdded:Connect(function(player)
        player.CharacterAdded:Connect(function(char)
            task.wait(1)
            applyPlayerESP(char, player)
        end)
    end)

    -- Also detect respawns for already-joined players
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            player.CharacterAdded:Connect(function(char)
                task.wait(1)
                applyPlayerESP(char, player)
            end)
        end
    end
end)

-- ‚úÖ Granny ESP
createButton("Granny ESP", function()
    local granny = nil
    for i = 1, 5 do
        local preset = workspace:FindFirstChild("Preset"..i)
        if preset and preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("Granny") then
            granny = preset.Locks.Granny
            break
        end
    end

    if granny then
        if not granny:FindFirstChildOfClass("Highlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "GrannyESP"
            highlight.Parent = granny
            highlight.Adornee = granny
            highlight.FillTransparency = 1
            highlight.OutlineTransparency = 0
            highlight.OutlineColor = Color3.fromRGB(255, 0, 0)
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        end
        createTracer(granny, Color3.fromRGB(255, 0, 0))
        if not granny:FindFirstChild("NameTag") then
            createNameTag(granny, "Granny", Color3.fromRGB(255, 0, 0))
        end
    else
        ErrorLog.Text = "Error Log: Granny not found in Preset1 to Preset5"
    end
end)

-- ‚úÖ Grandpa ESP
createButton("Grandpa ESP", function()
    local grandpa = nil
    for i = 1, 5 do
        local preset = workspace:FindFirstChild("Preset"..i)
        if preset and preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("Grandpa") then
            grandpa = preset.Locks.Grandpa
            break
        end
    end

    if grandpa then
        if not grandpa:FindFirstChildOfClass("Highlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "GrandpaESP"
            highlight.Parent = grandpa
            highlight.Adornee = grandpa
            highlight.FillTransparency = 1
            highlight.OutlineTransparency = 0
            highlight.OutlineColor = Color3.fromRGB(0, 255, 0)
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        end
        createTracer(grandpa, Color3.fromRGB(0, 255, 0))
        if not grandpa:FindFirstChild("NameTag") then
            createNameTag(grandpa, "Grandpa", Color3.fromRGB(0, 255, 0))
        end
    else
        ErrorLog.Text = "Error Log: Grandpa not found in Preset1 to Preset5"
    end
end)

-- ‚úÖ Item ESP for Granny Chapter 2
createButton("Item ESP", function()
    local itemNames = {
        "Boat key","Boat steering wheel","Crowbar","Cutting pliers","Door handle","Door lock",
        "Duct tape","Gasoline can","Glass fuse","Hand wheel","Helicopter key",
        "Padlock key","Safe key","Spark plug","Special key","Stun gun","Weapon key","Wrench"
    }

     for i = 1, 5 do
        local preset = workspace:FindFirstChild("Preset" .. i)
        if preset then
            for _, name in ipairs(itemNames) do
                local item = preset:FindFirstChild(name)
                if item then
                    -- Check for and apply Highlight
                    if not item:FindFirstChildOfClass("Highlight") then
                        local highlight = Instance.new("Highlight")
                        highlight.Name = "ItemESP"
                        highlight.Adornee = item
                        highlight.Parent = item
                        highlight.FillTransparency = 1 -- Outline only
                        highlight.OutlineTransparency = 0
                        highlight.OutlineColor = Color3.fromRGB(0, 255, 0) -- Green
                        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop -- X-ray
                    end

                    -- Check for and apply BillboardGui for name text
                    if not item:FindFirstChild("ItemLabel") then
                        local billboard = Instance.new("BillboardGui")
                        billboard.Name = "ItemLabel"
                        billboard.Size = UDim2.new(0, 200, 0, 50)
                        billboard.AlwaysOnTop = true
                        billboard.StudsOffset = Vector3.new(0, 2, 0)
                        billboard.Adornee = item
                        billboard.Parent = item

                        local label = Instance.new("TextLabel")
                        label.Size = UDim2.new(1, 0, 1, 0)
                        label.BackgroundTransparency = 1
                        label.TextColor3 = Color3.fromRGB(255, 255, 255)
                        label.TextStrokeTransparency = 0
                        label.Text = name
                        label.TextScaled = true
                        label.Font = Enum.Font.GothamBold
                        label.Parent = billboard
                    end
                end
            end
        end
    end
end)

-- ‚úÖ Get All Items + Extra Items
createButton("Get All Items", function()
    local player = LocalPlayer
    local backpack = player:FindFirstChild("Backpack") or Instance.new("Folder", player)
    backpack.Name = "Backpack"
    local character = player.Character or player.CharacterAdded:Wait()

    local function hasTool(toolName)
        return backpack:FindFirstChild(toolName) or character:FindFirstChild(toolName)
    end

    local function obtainItem(item)
        if not item then return end

        if item:FindFirstChild("InteractRemote") then
            item.InteractRemote:FireServer(player)
            print("Picked up via InteractRemote:", item.Name)

        elseif item:IsA("Tool") then
            local clone = item:Clone()
            clone.Parent = backpack
            print("Manually cloned tool:", item.Name)

        else
            print("‚ö†Ô∏è Unable to pick up item:", item.Name)
        end

        task.wait(0.1)
    end

    -- üîç Generic item collector for any instance path
    local function tryGet(path)
        local item = path
        if item then obtainItem(item) end
    end

    -- üîç Loop all Preset1‚Äì10, MiniPreset1‚Äì10, MeatPreset1‚Äì10
    for i = 1, 10 do
        local preset = workspace:FindFirstChild("Preset"..i)
        local mini = workspace:FindFirstChild("MiniPreset"..i)
        local meat = workspace:FindFirstChild("MeatPreset"..i)

        -- üîπ Get normal preset items
        if preset then
            for _, item in pairs(preset:GetChildren()) do
                if item:FindFirstChild("InteractRemote") then
                    obtainItem(item)
                end
            end

            -- Shotgun
            if preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("KeyCard Door") then
                local shotgun = preset.Locks["KeyCard Door"]:FindFirstChild("Shotgun")
                if shotgun then obtainItem(shotgun) end
            end

            -- Book
            if preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("Drawer") then
                local book = preset.Locks.Drawer:FindFirstChild("Book")
                if book then obtainItem(book) end
            end
        end

        -- üîπ MiniPreset grenades + picture pieces
        if mini then
            local grenadeBox = mini:FindFirstChild("GrenadeBox")
            if grenadeBox then
                obtainItem(grenadeBox:FindFirstChild("Grenade1"))
                obtainItem(grenadeBox:FindFirstChild("Grenade2"))
                obtainItem(grenadeBox:FindFirstChild("Grenade3"))
            end

            obtainItem(mini:FindFirstChild("A piece of a picture (1)"))
            obtainItem(mini:FindFirstChild("A piece of a picture (2)"))
            obtainItem(mini:FindFirstChild("A piece of a picture (3)"))
        end

        -- üîπ MeatPreset Meat
        if meat then
            local meatItem = meat:FindFirstChild("Meat")
            if meatItem then obtainItem(meatItem) end
        end
    end

    -- üîπ Get Slendrina Mask (always the same location)
    local mask = workspace:FindFirstChild("General Items") and workspace["General Items"]:FindFirstChild("SlendrinaMask")
    if mask then obtainItem(mask) end
end)

createButton("Infinite Ammo", function()
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    local ammo1 = LocalPlayer.Backpack:FindFirstChild("StunGunAmmo")
    local ammo2 = LocalPlayer.Backpack:FindFirstChild("ShotgunAmmo")

    if ammo1 or ammo2 then
        -- Keep ammo at 1 forever
        task.spawn(function()
            while true do
                if ammo1 and ammo1.Value ~= 1 then
                    ammo1.Value = 1
                end
                if ammo2 and ammo2.Value ~= 1 then
                    ammo2.Value = 1
                end
                task.wait(0.1)
            end
        end)

        print("Infinite Ammo enabled!")

        -- Updated Notification
        game.StarterGui:SetCore("SendNotification", {
            Title = "üî´ Infinite Ammo Enabled",
            Text = "Your stun gun & shotgun ammo will both stay at 1 forever.",
            Duration = 5
        })
    else
        warn("Error: StunGunAmmo or ShotgunAmmo not found in LocalPlayer.Backpack")
    end
end)

createButton("No Beartraps", function()
    local found = false

    for i = 1, 10 do
        local preset = workspace:FindFirstChild("Preset" .. i)
        if preset and preset:FindFirstChild("Locks") then
            local locks = preset.Locks
            if locks:FindFirstChild("Granny") then
                local granny = locks.Granny
                local beartrap = granny:FindFirstChild("BeartrapSpawn")

                if beartrap then
                    beartrap:Destroy()
                    ErrorLog.Text = "Error Log: Beartraps removed! (Preset" .. i .. ")"
                    found = true
                    break
                end
            end
        end
    end

    if not found then
        ErrorLog.Text = "Error Log: BeartrapSpawn not found in any preset"
    end
end)

-- ‚úÖ Granny Ignores You
createButton("Granny Ignores You", function()
    local grannyFolder, foundPresetIndex = nil, nil
    for i = 1, 5 do
        local preset = workspace:FindFirstChild("Preset"..i)
        if preset and preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("Granny") then
            grannyFolder = preset.Locks.Granny
            foundPresetIndex = i
            break
        end
    end

    if grannyFolder then
        for _, name in ipairs({"CameraJumpscare1","CameraJumpscare2","Jumpscare"}) do
            local obj = grannyFolder:FindFirstChild(name)
            if obj then obj:Destroy() end
        end
        if foundPresetIndex then
            local attackPath = workspace:FindFirstChild("Preset"..foundPresetIndex)
            if attackPath and attackPath:FindFirstChild("Locks") and attackPath.Locks:FindFirstChild("Granny") and attackPath.Locks.Granny:FindFirstChild("Attack") then
                attackPath.Locks.Granny.Attack:Destroy()
            end
        end
        print("Granny will now ignore you!")
    else
        ErrorLog.Text = "Error Log: Granny paths not found in Preset1 to Preset5."
    end
end)

-- ‚úÖ Grandpa Ignores You
createButton("Grandpa Ignores You", function()
    local grandpaFolder, foundPresetIndex = nil, nil
    for i = 1, 5 do
        local preset = workspace:FindFirstChild("Preset"..i)
        if preset and preset:FindFirstChild("Locks") and preset.Locks:FindFirstChild("Grandpa") then
            grandpaFolder = preset.Locks.Grandpa
            foundPresetIndex = i
            break
        end
    end

    if grandpaFolder then
        for _, name in ipairs({"CameraJumpscare1","CameraJumpscare2","Jumpscare"}) do
            local obj = grandpaFolder:FindFirstChild(name)
            if obj then obj:Destroy() end
        end
        if foundPresetIndex then
            local attackPath = workspace:FindFirstChild("Preset"..foundPresetIndex)
            if attackPath and attackPath:FindFirstChild("Locks") and attackPath.Locks:FindFirstChild("Grandpa") and attackPath.Locks.Grandpa:FindFirstChild("Attack") then
                attackPath.Locks.Grandpa.Attack:Destroy()
            end
        end
        print("Grandpa will now ignore you!")
    else
        ErrorLog.Text = "Error Log: Grandpa paths not found in Preset1 to Preset5."
    end
end)

-- ‚úÖ Remove Fall Animations
createButton("Remove Fall Animations", function()
    local paths = {
        workspace:FindFirstChild("GiveGUI") and workspace.GiveGUI:FindFirstChild("ShowGUI") and workspace.GiveGUI.ShowGUI:FindFirstChild("MainGUI") and workspace.GiveGUI.ShowGUI.MainGUI:FindFirstChild("FallSystem"),
        PlayerGui:FindFirstChild("MainGUI") and PlayerGui.MainGUI:FindFirstChild("FallSystem")
    }
    for _, obj in pairs(paths) do
        if obj then obj:Destroy() end
    end
    print("Fall animations successfully removed!")
    StarterGui:SetCore("SendNotification", {
        Title = "Removed Fall Animations!",
        Text = "Removes the falling animation system for smoother movement.",
        Duration = 5
    })
end)

-- ‚úÖ God Mode
createButton("God Mode", function()
    local char = LocalPlayer.Character or workspace:FindFirstChild(LocalPlayer.Name)
    if char then
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
                part.Anchored = false
                part.Transparency = 0.5
            end
        end
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid then humanoid.Name = "NotHumanoid" end

        local function safeDestroy(obj) if obj then obj:Destroy() end end
        local charInWorkspace = workspace:FindFirstChild(LocalPlayer.Name)
        if charInWorkspace then
            safeDestroy(charInWorkspace:FindFirstChild("Health"))
            local hrp = charInWorkspace:FindFirstChild("HumanoidRootPart")
            if hrp then safeDestroy(hrp:FindFirstChild("FreeFalling")) end
            local animate = charInWorkspace:FindFirstChild("Animate")
            if animate then safeDestroy(animate:FindFirstChild("fall")) end
        end
        local mainGui = PlayerGui:FindFirstChild("MainGUI")
        if mainGui then safeDestroy(mainGui:FindFirstChild("FallSystem")) end
    end
end)

createButton("TP to Spawn", function()
    LocalPlayer.Character:PivotTo(CFrame.new(-374, 4, 31))
end)

createButton("TP to Boat", function()
    LocalPlayer.Character:PivotTo(CFrame.new(-366, -9, 13))
end)

createButton("TP to Front Door", function()
    LocalPlayer.Character:PivotTo(CFrame.new(-364, 11, 27))
end)

createButton("Helicopter Pad", function()
    LocalPlayer.Character:PivotTo(CFrame.new(-358, 27, 24))
end)

createButton("Door Escape", function()
    LocalPlayer.Character:PivotTo(CFrame.new(-362.712097, 116.578186, 27.5977001, 1, 0, 0, 0, 1, 0, 0, 0, 1))
end)

createButton("Boat Escape", function()
    LocalPlayer.Character:PivotTo(CFrame.new(-380.002625, 117.425171, 27.4636917, 1, 0, 0, 0, 1, 0, 0, 0, 1))
end)

createButton("Helicopter Escape", function()
    LocalPlayer.Character:PivotTo(CFrame.new(-396.738953, 117.425171, 27.4636917, 1, 0, 0, 0, 1, 0, 0, 0, 1))
end)

-- ‚úÖ Full Bright
createButton("Full Bright", function()
    Lighting.Ambient = Color3.new(1, 1, 1)
    Lighting.Brightness = 3
    Lighting.FogEnd = 100000
    Lighting.ClockTime = 14
end)

-- ‚úÖ Unlock Camera
createButton("Unlock Camera", function()
    LocalPlayer.CameraMaxZoomDistance = 1000
    LocalPlayer.CameraMinZoomDistance = 0.5
end)
